<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SdGraphics Zip viewer</title>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://trygveb.se/SdGraphics/js/jszip.js"></script>
    <script src="https://trygveb.se/SdGraphics/js/jszip-utils.js"></script>
</head>
<body>
    <div style="background-color: #555555;height:500px; width:auto;max-width:400px;margin-left:10px;padding:10px; color:white;position:relative;">
        <!--<label id="zip_label" for="zip_file">Select a zip file:</label>
    <input type="file" id="zip_file" accept=".zip">-->

        <button id="zip_file_button" style="width:120px; height:25px;"
                onclick="document.getElementById('zip_file').click()">
            Select a zip file:
        </button>
        <input type='file' id="zip_file" style="display:none" accept=".zip">



        <label id="zip_file_name"></label>
        <label id="info"></label> <!-- Call number / number of calls -->
        <button id="new_file" style="display:none;float:right;" onclick="newFile()">New file</button>
        <br /><br />
        <img id="img1" style="display: block; margin-left: 20px;" />
        <br>
        <p id="call1"></p>
        <br />
        <img id="img2" style="display: block; margin-left: 20px;" />
        <br />
        <br />
        <div style="width:100%; position:absolute; bottom:25px">
            <div style="width:100%; display:inline-flex; justify-content: space-between;">
                <button id="button_prev5" disabled onclick="showPrevious5()">-5</button>
                <div style="display:inline-flex; justify-content: center;">
                    <button id="button_prev" disabled style="margin-right:10px;align-self: center;" onclick="showPrevious()">Prev</button>
                    <button id="button_next" style="margin-left:10px; center;" onclick="showNext()">Start</button>

                </div>
                <button id="button_next5" disabled style="margin-right:15px;" onclick="showNext5()">+5</button>
            </div>
        </div>
        <span id="copyright_span" style="font-size:small;position:absolute; left: 10px; bottom:5px;display:none">
            Copyright &copy; <span id="copyrightText"></span>
        </span>
    </div>
    <script type="text/javascript">

        $(document).ready(function () {
            myOnload();
        });
        let formations = [];
        let calls = [];
        let callNumber = 0;
        let forceImg2 = false;
        let atHome = false;
        let copyright = "Unknown";
        let status = "start";

        function myOnload() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const zipFile = urlParams.get('file')
            if (zipFile != null) {
                console.log('zipFile not null');
                loadHttpFile(zipFile);
            }
        };

        zip_file.onchange = function () {
            var zip = new JSZip();
            zip.loadAsync(this.files[0] /* = file blob */)
                .then(function (zip) {
                    zip.forEach(function (relativePath, zipEntry) {
                        zipEntry.async('uint8array').then(function (fileData) {
                            var exif = EXIF.readFromBinaryFile(fileData.buffer);
                            formations.push(fileData.buffer);
                            var comment = exif.UserComment;
                            if (typeof exif.Copyright !== 'undefined') {
                                copyright = exif.Copyright;
                            }
                            calls.push(comment);
                        }).then(function () {
                            document.getElementById('zip_file_button').style.display = "none";
                            document.getElementById('new_file').style.display = "inline";
                            //document.getElementById('button_next').style.display = "inline";
                            var zipFile = document.getElementById('zip_file');
                            document.getElementById('zip_file_name').innerText = zipFile.files.item(0).name;
                            document.getElementById('info').innerText = "0/"+calls.length;
                            document.getElementById('zip_file_button').innerText = 'SdGraphics ';
                        })

                    })
                }, function () { alert("Not a valid zip file") }
                )
        };

        function loadHttpFile(zipFile) {
            var promise = new JSZip.external.Promise(function (resolve, reject) {
                JSZipUtils.getBinaryContent(zipFile, function (err, data) {
                    if (err) {
                        reject(err);
                    } else {
                        resolve(data);
                    }
                });
            });
            promise.then(JSZip.loadAsync)
                .then(function (zip) {
                    zip.forEach(function (relativePath, zipEntry) {
                        zipEntry.async('uint8array').then(function (fileData) {
                            var exif = EXIF.readFromBinaryFile(fileData.buffer);
                            formations.push(fileData.buffer);
                            var comment = exif.UserComment;
                            if (typeof exif.Copyright !== 'undefined') {
                                copyright = exif.Copyright;
                            }
                            calls.push(comment);
                        }).then(function () {
                            document.getElementById('zip_file_button').style.display = "none";
                            document.getElementById('new_file').style.display = "inline";
                            //document.getElementById('button_next').style.display = "inline";

                            document.getElementById('zip_file_name').innerText = zipFile;
                            document.getElementById('zip_file_button').innerText = 'SdGraphics ';

                        })

                    })
                })
                .then(function success(text) {                    // 4) display the result
                    console.log("OK 2");
                }, function error(e) {
                    console.log(e);
                });
        }

        function displayCall() {
            console.log('displayCall callNumber=' + callNumber);

            //document.getElementById('img2').style.display = "none";
            document.getElementById("call1").innerHTML = (callNumber + 1) + ") " + calls[callNumber];
            document.getElementById('img1').src = getUrl(callNumber);
            document.getElementById('info').innerText = (callNumber+1)+"/" + calls.length;
            if (calls[callNumber].includes("at home")) {
                atHome = true;
            } else {
                atHome = false;
                document.getElementById('img2').src = getUrl(callNumber + 1);
            }

        }

        function fixButton(buttonId, enable) {
            button = document.getElementById('button_' + buttonId);
            if (enable) {
                button.disabled = false;
            } else {
                button.disabled = true;
            }
        }

        function fixButtons() {
            fixButton("prev", callNumber > 1);
            fixButton("prev5", callNumber > 5);
            fixButton("next5", (callNumber < calls.length - 5));
            fixButton("next", callNumber < calls.length);

        }

        function getUrl(j1) {
            var blob = new Blob([formations[j1]], { 'type': 'image/jpg' });
            var url = URL.createObjectURL(blob);
            return url;
        }

        function newFile() {
            location.reload();
        }

        function showNext() {

            console.log('showNext callNumber=' + callNumber + ', status=' + status + ', atHome=' + atHome);
            if (callNumber >= calls.length) {
                return;
            }
            if (status === "start") {
                document.getElementById('copyrightText').innerText = copyright;
                document.getElementById('copyright_span').style.display = "block";
                document.getElementById('button_next').innerText = "Next";
                document.getElementById('img2').style.display = "none";
                status = "first";
                console.log('showNext status=' + status);
            }
            if (status === "second") {
                status = "first";
                console.log('showNext status=' + status);
                if (atHome) {
                    callNumber += 1;
                    showNext();
                } else {
                    document.getElementById('img2').style.display = "block";
                    displayCall();
                    callNumber += 1;
                }
            } else {
                document.getElementById('img2').style.display = "none";
                document.getElementById('button_next5').disabled = true;
                if (atHome) {
                    atHome = false;
                }
                status = "second";
                displayCall();

            }
            fixButtons();
        }

        function showNext5() {
            status = "first";
            console.log('showNext5 status=' + status);
            callNumber += 5;
            showNext();
        }

        function showNextSeq() {
            for (i1 = callNumber; i1 < calls.length; i1++) {
                callNumber = i1;
                if (calls[i1].includes("at home")) {
                    break;
                }
            }
            showNext();
        }

        function showPrevious() {
            console.log('showPrev callNumber=' + callNumber);
            callNumber -= 2;  // back 2 as callNumber is already incremented
            if (callNumber < 0) {
                callNumber = 0;
            }
            displayCall();
            callNumber += 1;
            console.log('showPrev callNumber=' + callNumber);

        }

        function showPrevious5() {
            status = "first";
            console.log('showPrevious5 status=' + status);
            callNumber -= 5;
            if (callNumber < 0) {
                callNumber = 0;
            }

            showNext();

        }

    </script>

</body >

</html >
